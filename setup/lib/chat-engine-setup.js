!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ChatEngineSetupCore=t():e.ChatEngineSetupCore=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t){e.exports={findCookie:e=>{let t=null;return document.cookie.split(";").forEach(n=>{let r=n.split("=")[0],o=n.split("=")[1];r.endsWith(e)&&(t=o)}),t},callbackWithError:(e,t,n)=>e&&e.responseJSON&&e.responseJSON.message?n(e.responseJSON.message):n(t)}},function(e,t,n){n(2);const r=n(7),o=n(8),i=n(0);e.exports=class{constructor(){this.loginElement=$("#login"),this.provisionElement=$("#setup"),this.loadElement=$("#load"),this.errorElement=$("#error"),this.errorOutElement=$("#error-out"),this.statusElement=$("#status"),this.codeElement=$("#code"),this.outputElement=$("#output"),this.emailElement=$("#email"),this.passwordElement=$("#password"),this.loginElement.submit(this.onLoginRegister.bind(this)),this.provisionElement.submit(this.onSetup.bind(this)),this.userId=i.findCookie("pnAdminId");let e=i.findCookie("pnAdminToken");this.client=new r({session:e,debug:!1,endpoint:"https://admin.pubnub.com"}),this.userId&&e&&(this.provisionElement.show(),this.loginElement.hide(),this.identify(this.userId))}displayStatus(e){this.statusElement.show(),this.statusElement.append($('<li class="list-group-item">'+e+"</li>"))}clearErrors(){this.errorElement.hide()}raiseError(e){this.errorOutElement.html(e),this.errorElement.show()}onProvisionSuccess(e,t){if(e)this.loadElement.hide(),this.provisionElement.show(),this.errorOutElement.html(e),this.errorElement.show();else{this.loadElement.hide();let e="";e+="// Make sure to import ChatEngine first!\n",e+="ChatEngine = ChatEngineCore.create({\n",e+="    publishKey: '"+t.pub+"',\n",e+="    subscribeKey: '"+t.sub+"'\n",e+="});\n",this.track("chat_engine_activation"),this.codeElement.text(e),this.outputElement.show()}}onLoginRegister(){this.clearErrors();const e=this.emailElement.val(),t=this.passwordElement.val();return e&&""!==e?t&&""!==t?(this.client.init({email:e,password:t},(e,t)=>{e?this.raiseError((e=>{if(e&&e.responseJSON&&e.responseJSON.error)return e.responseJSON.error})(e)):(this.userId=t.result.user_id,this.identify(this.userId),this.provisionElement.show(),this.loginElement.hide())}),!1):(this.raiseError("password not valid"),!1):(this.raiseError("email not valid"),!1)}onSetup(){return this.clearErrors(),this.loadElement.show(),this.errorElement.hide(),this.statusElement.empty(),o(this.client,this.userId,this.onProvisionSuccess.bind(this),this.displayStatus.bind(this)),!1}identify(e){const t={type:"identify",anonymousId:document.cookie.substring(document.cookie.indexOf("=")+4,document.cookie.indexOf(";")-3),context:{library:{name:"PubNub Functions",version:"0.0.1"},page:{path:location.pathname,url:location.href,title:document.title,search:location.search,referrer:document.referrer},userAgent:navigator.userAgent},userId:e};$.ajax({type:"POST",url:"https://pubsub.pubnub.com/v1/blocks/sub-key/sub-c-218ba154-c8ba-11e7-9178-bafd478c18bc/analytics",data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}track(e){const t={type:"track",anonymousId:document.cookie.substring(document.cookie.indexOf("=")+4,document.cookie.indexOf(";")-3),event:e,context:{library:{name:"PubNub Functions",version:"0.0.1"},page:{path:location.pathname,url:location.href,title:document.title,search:location.search,referrer:document.referrer},userAgent:navigator.userAgent},userId:this.userId};$.ajax({type:"POST",url:"https://pubsub.pubnub.com/v1/blocks/sub-key/sub-c-218ba154-c8ba-11e7-9178-bafd478c18bc/analytics",data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}}},function(e,t,n){"use strict";e.exports=n(3).polyfill()},function(e,t,n){(function(t,r){!function(t,n){e.exports=n()}(0,function(){"use strict";function e(e){return"function"==typeof e}function o(){var e=setTimeout;return function(){return e(i,1)}}function i(){for(var e=0;e<P;e+=2){(0,$[e])($[e+1]),$[e]=void 0,$[e+1]=void 0}P=0}function s(){try{var e=n(6);return void 0!==(T=e.runOnLoop||e.runOnContext)?function(){T(i)}:o()}catch(e){return o()}}function u(e,t){var n=arguments,r=this,o=new this.constructor(c);void 0===o[I]&&_(o);var i=r._state;return i?function(){var e=n[i-1];S(function(){return g(i,o,e,r._result)})}():m(r,o,e,t),o}function a(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(c);return h(t,e),t}function c(){}function l(e){try{return e.then}catch(e){return H.error=e,H}}function p(t,n,r){n.constructor===t.constructor&&r===u&&n.constructor.resolve===a?function(e,t){t._state===W?f(e,t._result):t._state===M?b(e,t._result):m(t,void 0,function(t){return h(e,t)},function(t){return b(e,t)})}(t,n):r===H?(b(t,H.error),H.error=null):void 0===r?f(t,n):e(r)?function(e,t,n){S(function(e){var r=!1,o=function(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}(n,t,function(n){r||(r=!0,t!==n?h(e,n):f(e,n))},function(t){r||(r=!0,b(e,t))},e._label);!r&&o&&(r=!0,b(e,o))},e)}(t,n,r):f(t,n)}function h(e,t){e===t?b(e,new TypeError("You cannot resolve a promise with itself")):!function(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}(t)?f(e,t):p(e,t,l(t))}function d(e){e._onerror&&e._onerror(e._result),y(e)}function f(e,t){e._state===F&&(e._result=t,e._state=W,0!==e._subscribers.length&&S(y,e))}function b(e,t){e._state===F&&(e._state=M,e._result=t,S(d,e))}function m(e,t,n,r){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=t,o[i+W]=n,o[i+M]=r,0===i&&e._state&&S(y,e)}function y(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r=void 0,o=void 0,i=e._result,s=0;s<t.length;s+=3)r=t[s],o=t[s+n],r?g(n,r,o,i):o(i);e._subscribers.length=0}}function v(){this.error=null}function g(t,n,r,o){var i=e(r),s=void 0,u=void 0,a=void 0,c=void 0;if(i){if((s=function(e,t){try{return e(t)}catch(e){return J.error=e,J}}(r,o))===J?(c=!0,u=s.error,s.error=null):a=!0,n===s)return void b(n,new TypeError("A promises callback cannot return that same promise."))}else s=o,a=!0;n._state!==F||(i&&a?h(n,s):c?b(n,u):t===W?f(n,s):t===M&&b(n,s))}function _(e){e[I]=K++,e._state=void 0,e._result=void 0,e._subscribers=[]}function w(e,t){this._instanceConstructor=e,this.promise=new e(c),this.promise[I]||_(this.promise),k(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?f(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&f(this.promise,this._result))):b(this.promise,new Error("Array Methods must be provided an Array"))}function E(e){this[I]=K++,this._result=this._state=void 0,this._subscribers=[],c!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof E?function(e,t){try{t(function(t){h(e,t)},function(t){b(e,t)})}catch(t){b(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}var k=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},P=0,T=void 0,x=void 0,S=function(e,t){$[P]=e,$[P+1]=t,2===(P+=2)&&(x?x(i):q())},j="undefined"!=typeof window?window:void 0,C=j||{},A=C.MutationObserver||C.WebKitMutationObserver,O="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),N="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,$=new Array(1e3),q=void 0;q=O?function(){return t.nextTick(i)}:A?function(){var e=0,t=new A(i),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}():N?function(){var e=new MessageChannel;return e.port1.onmessage=i,function(){return e.port2.postMessage(0)}}():void 0===j?s():o();var I=Math.random().toString(36).substring(16),F=void 0,W=1,M=2,H=new v,J=new v,K=0;return w.prototype._enumerate=function(e){for(var t=0;this._state===F&&t<e.length;t++)this._eachEntry(e[t],t)},w.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===a){var o=l(e);if(o===u&&e._state!==F)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(n===E){var i=new n(c);p(i,e,o),this._willSettleAt(i,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},w.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===F&&(this._remaining--,e===M?b(r,n):this._result[t]=n),0===this._remaining&&f(r,this._result)},w.prototype._willSettleAt=function(e,t){var n=this;m(e,void 0,function(e){return n._settledAt(W,t,e)},function(e){return n._settledAt(M,t,e)})},E.all=function(e){return new w(this,e).promise},E.race=function(e){var t=this;return k(e)?new t(function(n,r){for(var o=e.length,i=0;i<o;i++)t.resolve(e[i]).then(n,r)}):new t(function(e,t){return t(new TypeError("You must pass an array to race."))})},E.resolve=a,E.reject=function(e){var t=new this(c);return b(t,e),t},E._setScheduler=function(e){x=e},E._setAsap=function(e){S=e},E._asap=S,E.prototype={constructor:E,then:u,catch:function(e){return this.then(null,e)}},E.polyfill=function(){var e=void 0;if(void 0!==r)e=r;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=E},E.Promise=E,E})}).call(t,n(4),n(5))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function o(e){if(c===setTimeout)return setTimeout(e,0);if((c===n||!c)&&setTimeout)return c=setTimeout,setTimeout(e,0);try{return c(e,0)}catch(t){try{return c.call(null,e,0)}catch(t){return c.call(this,e,0)}}}function i(){f&&h&&(f=!1,h.length?d=h.concat(d):b=-1,d.length&&s())}function s(){if(!f){var e=o(i);f=!0;for(var t=d.length;t;){for(h=d,d=[];++b<t;)h&&h[b].run();b=-1,t=d.length}h=null,f=!1,function(e){if(l===clearTimeout)return clearTimeout(e);if((l===r||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(e);try{l(e)}catch(t){try{return l.call(null,e)}catch(t){return l.call(this,e)}}}(e)}}function u(e,t){this.fun=e,this.array=t}function a(){}var c,l,p=e.exports={};!function(){try{c="function"==typeof setTimeout?setTimeout:n}catch(e){c=n}try{l="function"==typeof clearTimeout?clearTimeout:r}catch(e){l=r}}();var h,d=[],f=!1,b=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];d.push(new u(e,t)),1!==d.length||f||o(s)},u.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=a,p.addListener=a,p.once=a,p.off=a,p.removeListener=a,p.removeAllListeners=a,p.emit=a,p.prependListener=a,p.prependOnceListener=a,p.listeners=function(e){return[]},p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){},function(e,t){e.exports=class{constructor(e){e=e||{},this.endpoint=e.endpoint||"https://admin.pubnub.com",this.session=e.session||!1,this.debug=e.debug||!1}errHandle(e){this.debug&&console.error("API Error: "+e)}clog(e){this.debug&&("object"==typeof e?console.log(e):console.log("API:".yellow,e))}request(e,t,n,r){if("me"!==t[1]&&!this.session)return this.errHandle("Authorize with init() first.");(n=n||{}).url=this.endpoint+"/"+t.join("/"),n.method=e,n.json=!0,n.headers=n.headers||{},this.session&&(n.headers["X-Session-Token"]=this.session),this.clog(n.method.red+" "+n.url),this.clog("-- opts:".yellow),this.clog(n),$.ajax(n).done(e=>{console.log(e),r(null,e)}).fail(e=>{console.log("fail",e),r(e||e.message||e)})}init(e,t){this.request("post",["api","me"],{data:{email:e.email||this.errHandle("No Email Supplied"),password:e.password||this.errHandle("No Password Supplied")}},(e,n)=>{n&&n.error?t(n.error):e?t(e):(this.session=n.result.token,t(null,n))})}startFunction({block:e,key:t},n){this.request("post",["api","v1","blocks","key",t.id,"block",e.id,"start"],{data:{block_id:e.id,key_id:t.id,action:"start"}},n)}storeSecretKey({key:e},t){this.request("put",["api","vault",e.subscribe_key,"key","secretKey"],{contentType:"application/json",data:JSON.stringify({keyName:"secretKey",key_id:e.id,subscribeKey:e.subscribe_key,value:e.secret_key})},t)}}},function(e,t,n){const r=n(9),o=n(0);e.exports=((e,t,n=(()=>{}),i=(()=>{}))=>{e.request("get",["api","accounts"],{data:{user_id:t}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not get PubNub accounts. Please contact support@pubnub.com.",n)}let a=u.result.accounts[0];i("Using account "+a.properties.company+", if this is incorrect, deploy manually or log in as another user"),i("Creating new PubNub app..."),e.request("post",["api","apps"],{data:{name:"ChatEngine App",owner_id:a.id,properties:{}}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not create new PubNub app. Please contact support@pubnub.com.",n)}let c=u.result;i("Getting PubNub keys..."),e.request("get",["api","apps"],{data:{owner_id:a.id}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not get PubNub keys. Please contact support@pubnub.com.",n)}let a;u.result.forEach(e=>{e.id===c.id&&(a=e.keys[0])}),i("Enabling PubNub features..."),a.properties.name="ChatEngine Keyset",a.properties.presence=1,a.properties.history=1,a.properties.message_storage_ttl=7,a.properties.multiplexing=1,a.properties.presence_announce_max=20,a.properties.presence_debounce=2,a.properties.presence_global_here_now=1,a.properties.presence_interval=10,a.properties.presence_leave_on_disconnect=0,a.properties.blocks=1,a.properties.uls=1,a.properties.wildcardsubscribe=1,e.request("put",["api","keys",a.id],{data:a},s=>{if(s){return o.callbackWithError(s,"Could not enable PubNub features. Please contact support@pubnub.com.",n)}r(e,t,a,n,i)})})})})})},function(e,t,n){const r=n(0);e.exports=((e,t,n,o=(()=>{}),i=(()=>{}))=>{let s=null;i("Creating new PubNub Function...");let u=(t,u,a)=>{i("Creating new after-publish Event Handler..."),e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,type:"js",event:"js-after-presence",channels:"*",name:"chat-engine-state",code:t[0],output:"output-state-to-kv-"+(new Date).getTime()}},(t,c)=>{if(t){return r.callbackWithError(t,"Could not create new PubNub after-publish Event Handler. Please contact support@pubnub.com.",o)}e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,type:"js",event:"js-on-rest",path:"chat-engine-auth",name:"chat-engine-auth",code:u[0],output:"auth-"+Math.round((new Date).getTime())}},(t,u)=>{if(t){return r.callbackWithError(t,"Could not create new PubNub after-publish Event Handler. Please contact support@pubnub.com.",o)}i("Creating new on-request Event Handler..."),a[0]=a[0].replace("SECRET_KEY",n.secret_key),e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,code:a[0],type:"js",name:"chat-engine-server",path:"chat-engine-server",event:"js-on-rest",output:"output-server-endpoint-"+Math.round((new Date).getTime())}},(t,u)=>{if(t){return r.callbackWithError(t,"Could not create new Pubnub on-request Event Handler. Please contact support@pubnub.com.",o)}i("Starting Pubnub Function..."),e.startFunction({block:s,key:n},e=>{if(e)return r.callbackWithError(e,"Could not start PubNub Function. Please contact support@pubnub.com.",o);i("Success!"),o(null,{pub:n.publish_key,sub:n.subscribe_key})})})})})};e.request("post",["api","v1","blocks","key",n.id,"block"],{data:{name:"ChatEngine Function",key_id:n.id}},(e,t)=>{if(e){return r.callbackWithError(e,"Could not create new PubNub Function. Please contact support@pubnub.com.",o)}s=t.payload;let n=$.get({url:"functions/state-to-kv.js",dataType:"text"}),a=$.get({url:"functions/auth.js",dataType:"text"}),c=$.get({url:"functions/server.js",dataType:"text"});$.when(n,a,c).then(u).catch(()=>{i("Failed to fetch code")})})})}])});