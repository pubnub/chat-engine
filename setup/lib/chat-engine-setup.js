!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ChatEngineSetupCore=t():e.ChatEngineSetupCore=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t){e.exports={findCookie:e=>{let t=null;return document.cookie.split(";").forEach(n=>{let r=n.split("=")[0],o=n.split("=")[1];r.endsWith(e)&&(t=o)}),t},callbackWithError:(e,t,n)=>e&&e.responseJSON&&e.responseJSON.message?n(e.responseJSON.message):n(t)}},function(e,t,n){n(2);const r=n(7),o=n(8),i=n(0);e.exports=class{constructor(){this.loginElement=$("#login"),this.provisionElement=$("#setup"),this.loadElement=$("#load"),this.errorElement=$("#error"),this.errorOutElement=$("#error-out"),this.statusElement=$("#status"),this.codeElement=$("#code"),this.outputElement=$("#output"),this.emailElement=$("#email"),this.passwordElement=$("#password"),this.loginElement.submit(this.onLoginRegister.bind(this)),this.provisionElement.submit(this.onSetup.bind(this)),this.userId=i.findCookie("pnAdminId");let e=i.findCookie("pnAdminToken");this.client=new r({session:e,debug:!1,endpoint:"https://admin.pubnub.com"}),this.userId&&e&&(this.provisionElement.show(),this.loginElement.hide(),this.identify(this.userId))}displayStatus(e){this.statusElement.show(),this.statusElement.append($('<li class="list-group-item">'+e+"</li>"))}clearErrors(){this.errorElement.hide()}raiseError(e){this.errorOutElement.html(e),this.errorElement.show()}onProvisionSuccess(e,t){if(e)this.loadElement.hide(),this.provisionElement.show(),this.errorOutElement.html(e),this.errorElement.show();else{this.loadElement.hide();let e="";e+="// Make sure to import ChatEngine first!\n",e+="ChatEngine = ChatEngineCore.create({\n",e+="    publishKey: '"+t.pub+"',\n",e+="    subscribeKey: '"+t.sub+"'\n",e+="});\n",this.track("chat_engine_activation"),this.codeElement.text(e),this.outputElement.show()}}onLoginRegister(){this.clearErrors();const e=this.emailElement.val(),t=this.passwordElement.val();return e&&""!==e?t&&""!==t?(this.client.init({email:e,password:t},(e,t)=>{e?this.raiseError((e=>{if(e&&e.responseJSON&&e.responseJSON.error)return e.responseJSON.error})(e)):(this.userId=t.result.user_id,this.identify(this.userId),this.provisionElement.show(),this.loginElement.hide())}),!1):(this.raiseError("password not valid"),!1):(this.raiseError("email not valid"),!1)}onSetup(){return this.clearErrors(),this.loadElement.show(),this.errorElement.hide(),this.statusElement.empty(),o(this.client,this.userId,this.onProvisionSuccess.bind(this),this.displayStatus.bind(this)),!1}identify(e){const t={type:"identify",anonymousId:document.cookie.substring(document.cookie.indexOf("=")+4,document.cookie.indexOf(";")-3),context:{library:{name:"PubNub Functions",version:"0.0.1"},page:{path:location.pathname,url:location.href,title:document.title,search:location.search,referrer:document.referrer},userAgent:navigator.userAgent},userId:e};$.ajax({type:"POST",url:"https://pubsub.pubnub.com/v1/blocks/sub-key/sub-c-218ba154-c8ba-11e7-9178-bafd478c18bc/analytics",data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}track(e){const t={type:"track",anonymousId:document.cookie.substring(document.cookie.indexOf("=")+4,document.cookie.indexOf(";")-3),event:e,context:{library:{name:"PubNub Functions",version:"0.0.1"},page:{path:location.pathname,url:location.href,title:document.title,search:location.search,referrer:document.referrer},userAgent:navigator.userAgent},userId:this.userId};$.ajax({type:"POST",url:"https://pubsub.pubnub.com/v1/blocks/sub-key/sub-c-218ba154-c8ba-11e7-9178-bafd478c18bc/analytics",data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}}},function(e,t,n){"use strict";e.exports=n(3).polyfill()},function(e,t,n){(function(t,r){var o;o=function(){"use strict";function e(e){return"function"==typeof e}var o=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},i=0,s=void 0,u=void 0,a=function(e,t){b[i]=e,b[i+1]=t,2===(i+=2)&&(u?u(m):w())};var c="undefined"!=typeof window?window:void 0,l=c||{},p=l.MutationObserver||l.WebKitMutationObserver,h="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),d="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function f(){var e=setTimeout;return function(){return e(m,1)}}var b=new Array(1e3);function m(){for(var e=0;e<i;e+=2){(0,b[e])(b[e+1]),b[e]=void 0,b[e+1]=void 0}i=0}var y,v,g,_,w=void 0;function E(e,t){var n=this,r=new this.constructor(T);void 0===r[P]&&L(r);var o=n._state;if(o){var i=arguments[o-1];a(function(){return J(o,r,i,n._result)})}else F(n,r,e,t);return r}function k(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(T);return N(t,e),t}h?w=function(){return t.nextTick(m)}:p?(v=0,g=new p(m),_=document.createTextNode(""),g.observe(_,{characterData:!0}),w=function(){_.data=v=++v%2}):d?((y=new MessageChannel).port1.onmessage=m,w=function(){return y.port2.postMessage(0)}):w=void 0===c?function(){try{var e=n(6);return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(m)}:f()}catch(e){return f()}}():f();var P=Math.random().toString(36).substring(16);function T(){}var x=void 0,S=1,j=2,C=new M;function A(e){try{return e.then}catch(e){return C.error=e,C}}function O(t,n,r){var o,i,s,u;n.constructor===t.constructor&&r===E&&n.constructor.resolve===k?(s=t,(u=n)._state===S?q(s,u._result):u._state===j?I(s,u._result):F(u,void 0,function(e){return N(s,e)},function(e){return I(s,e)})):r===C?(I(t,C.error),C.error=null):void 0===r?q(t,n):e(r)?(o=n,i=r,a(function(e){var t=!1,n=function(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}(i,o,function(n){t||(t=!0,o!==n?N(e,n):q(e,n))},function(n){t||(t=!0,I(e,n))},e._label);!t&&n&&(t=!0,I(e,n))},t)):q(t,n)}function N(e,t){var n,r;e===t?I(e,new TypeError("You cannot resolve a promise with itself")):(r=typeof(n=t),null===n||"object"!==r&&"function"!==r?q(e,t):O(e,t,A(t)))}function $(e){e._onerror&&e._onerror(e._result),W(e)}function q(e,t){e._state===x&&(e._result=t,e._state=S,0!==e._subscribers.length&&a(W,e))}function I(e,t){e._state===x&&(e._state=j,e._result=t,a($,e))}function F(e,t,n,r){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=t,o[i+S]=n,o[i+j]=r,0===i&&e._state&&a(W,e)}function W(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r=void 0,o=void 0,i=e._result,s=0;s<t.length;s+=3)r=t[s],o=t[s+n],r?J(n,r,o,i):o(i);e._subscribers.length=0}}function M(){this.error=null}var H=new M;function J(t,n,r,o){var i=e(r),s=void 0,u=void 0,a=void 0,c=void 0;if(i){if((s=function(e,t){try{return e(t)}catch(e){return H.error=e,H}}(r,o))===H?(c=!0,u=s.error,s.error=null):a=!0,n===s)return void I(n,new TypeError("A promises callback cannot return that same promise."))}else s=o,a=!0;n._state!==x||(i&&a?N(n,s):c?I(n,u):t===S?q(n,s):t===j&&I(n,s))}var K=0;function L(e){e[P]=K++,e._state=void 0,e._result=void 0,e._subscribers=[]}var D=function(){function e(e,t){this._instanceConstructor=e,this.promise=new e(T),this.promise[P]||L(this.promise),o(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?q(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&q(this.promise,this._result))):I(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===x&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===k){var o=A(e);if(o===E&&e._state!==x)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(n===Y){var i=new n(T);O(i,e,o),this._willSettleAt(i,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},e.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===x&&(this._remaining--,e===j?I(r,n):this._result[t]=n),0===this._remaining&&q(r,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;F(e,void 0,function(e){return n._settledAt(S,t,e)},function(e){return n._settledAt(j,t,e)})},e}();var Y=function(){function e(t){this[P]=K++,this._result=this._state=void 0,this._subscribers=[],T!==t&&("function"!=typeof t&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof e?function(e,t){try{t(function(t){N(e,t)},function(t){I(e,t)})}catch(t){I(e,t)}}(this,t):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return e.prototype.catch=function(e){return this.then(null,e)},e.prototype.finally=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){throw n})})},e}();return Y.prototype.then=E,Y.all=function(e){return new D(this,e).promise},Y.race=function(e){var t=this;return o(e)?new t(function(n,r){for(var o=e.length,i=0;i<o;i++)t.resolve(e[i]).then(n,r)}):new t(function(e,t){return t(new TypeError("You must pass an array to race."))})},Y.resolve=k,Y.reject=function(e){var t=new this(T);return I(t,e),t},Y._setScheduler=function(e){u=e},Y._setAsap=function(e){a=e},Y._asap=a,Y.polyfill=function(){var e=void 0;if(void 0!==r)e=r;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=Y},Y.Promise=Y,Y},e.exports=o()}).call(t,n(4),n(5))},function(e,t){var n,r,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function u(e){if(n===setTimeout)return setTimeout(e,0);if((n===i||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:i}catch(e){n=i}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var a,c=[],l=!1,p=-1;function h(){l&&a&&(l=!1,a.length?c=a.concat(c):p=-1,c.length&&d())}function d(){if(!l){var e=u(h);l=!0;for(var t=c.length;t;){for(a=c,c=[];++p<t;)a&&a[p].run();p=-1,t=c.length}a=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function b(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new f(e,t)),1!==c.length||l||u(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=b,o.addListener=b,o.once=b,o.off=b,o.removeListener=b,o.removeAllListeners=b,o.emit=b,o.prependListener=b,o.prependOnceListener=b,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){},function(e,t){e.exports=class{constructor(e){e=e||{},this.endpoint=e.endpoint||"https://admin.pubnub.com",this.session=e.session||!1,this.debug=e.debug||!1}errHandle(e){this.debug&&console.error("API Error: "+e)}clog(e){this.debug&&("object"==typeof e?console.log(e):console.log("API:".yellow,e))}request(e,t,n,r){if("me"!==t[1]&&!this.session)return this.errHandle("Authorize with init() first.");(n=n||{}).url=this.endpoint+"/"+t.join("/"),n.method=e,n.json=!0,n.headers=n.headers||{},this.session&&(n.headers["X-Session-Token"]=this.session),this.clog(n.method.red+" "+n.url),this.clog("-- opts:".yellow),this.clog(n),$.ajax(n).done(e=>{console.log(e),r(null,e)}).fail(e=>{console.log("fail",e),r(e||e.message||e)})}init(e,t){this.request("post",["api","me"],{data:{email:e.email||this.errHandle("No Email Supplied"),password:e.password||this.errHandle("No Password Supplied")}},(e,n)=>{n&&n.error?t(n.error):e?t(e):(this.session=n.result.token,t(null,n))})}startFunction({block:e,key:t},n){this.request("post",["api","v1","blocks","key",t.id,"block",e.id,"start"],{data:{block_id:e.id,key_id:t.id,action:"start"}},n)}storeSecretKey({key:e},t){this.request("put",["api","vault",e.subscribe_key,"key","secretKey"],{contentType:"application/json",data:JSON.stringify({keyName:"secretKey",key_id:e.id,subscribeKey:e.subscribe_key,value:e.secret_key})},t)}}},function(e,t,n){const r=n(9),o=n(0);e.exports=((e,t,n=(()=>{}),i=(()=>{}))=>{e.request("get",["api","accounts"],{data:{user_id:t}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not get PubNub accounts. Please contact support@pubnub.com.",n)}let a=u.result.accounts[0];i("Using account "+a.properties.company+", if this is incorrect, deploy manually or log in as another user"),i("Creating new PubNub app..."),e.request("post",["api","apps"],{data:{name:"ChatEngine App",owner_id:a.id,properties:{}}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not create new PubNub app. Please contact support@pubnub.com.",n)}let c=u.result;i("Getting PubNub keys..."),e.request("get",["api","apps"],{data:{owner_id:a.id}},(s,u)=>{if(s){return o.callbackWithError(s,"Could not get PubNub keys. Please contact support@pubnub.com.",n)}let a;u.result.forEach(e=>{e.id===c.id&&(a=e.keys[0])}),i("Enabling PubNub features..."),a.properties.name="ChatEngine Keyset",a.properties.presence=1,a.properties.history=1,a.properties.message_storage_ttl=7,a.properties.multiplexing=1,a.properties.presence_announce_max=20,a.properties.presence_debounce=2,a.properties.presence_global_here_now=1,a.properties.presence_interval=10,a.properties.presence_leave_on_disconnect=0,a.properties.blocks=1,a.properties.uls=1,a.properties.wildcardsubscribe=1,e.request("put",["api","keys",a.id],{data:a},s=>{if(s){return o.callbackWithError(s,"Could not enable PubNub features. Please contact support@pubnub.com.",n)}r(e,t,a,n,i)})})})})})},function(e,t,n){const r=n(0);e.exports=((e,t,n,o=(()=>{}),i=(()=>{}))=>{let s=null;i("Creating new PubNub Function...");let u=(t,u,a)=>{i("Creating new after-publish Event Handler..."),e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,type:"js",event:"js-after-presence",channels:"*",name:"chat-engine-state",code:t[0],output:"output-state-to-kv-"+(new Date).getTime()}},(t,c)=>{if(t){return r.callbackWithError(t,"Could not create new PubNub after-publish Event Handler. Please contact support@pubnub.com.",o)}e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,type:"js",event:"js-on-rest",path:"chat-engine-auth",name:"chat-engine-auth",code:u[0],output:"auth-"+Math.round((new Date).getTime())}},(t,u)=>{if(t){return r.callbackWithError(t,"Could not create new PubNub after-publish Event Handler. Please contact support@pubnub.com.",o)}i("Creating new on-request Event Handler..."),a[0]=a[0].replace("SECRET_KEY",n.secret_key),e.request("post",["api","v1","blocks","key",n.id,"event_handler"],{data:{key_id:n.id,block_id:s.id,code:a[0],type:"js",name:"chat-engine-server",path:"chat-engine-server",event:"js-on-rest",output:"output-server-endpoint-"+Math.round((new Date).getTime())}},(t,u)=>{if(t){return r.callbackWithError(t,"Could not create new Pubnub on-request Event Handler. Please contact support@pubnub.com.",o)}i("Starting Pubnub Function..."),e.startFunction({block:s,key:n},e=>{if(e)return r.callbackWithError(e,"Could not start PubNub Function. Please contact support@pubnub.com.",o);i("Success!"),o(null,{pub:n.publish_key,sub:n.subscribe_key})})})})})};e.request("post",["api","v1","blocks","key",n.id,"block"],{data:{name:"ChatEngine Function",key_id:n.id}},(e,t)=>{if(e){return r.callbackWithError(e,"Could not create new PubNub Function. Please contact support@pubnub.com.",o)}s=t.payload;let n=$.get({url:"functions/state-to-kv.js",dataType:"text"}),a=$.get({url:"functions/auth.js",dataType:"text"}),c=$.get({url:"functions/server.js",dataType:"text"});$.when(n,a,c).then(u).catch(()=>{i("Failed to fetch code")})})})}])});